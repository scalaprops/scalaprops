name: CI
on:
  pull_request:
  push:
  schedule:
  - cron: '0 6 * * 3'
jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    strategy:
      fail-fast: false
      matrix:
        name: [jvm, js, native]
        scala: ["2.12.*", "2.13.*", "3.*"]
        java: [8]
        include:
          - name: jvm
            scala: "2.13.*"
            java: 17
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
    - uses: actions/setup-java@3f07048e3d294f56e9b90ac5ea2c6f74e9ad0f98 # v3.10.0
      with:
        java-version: ${{matrix.java}}
        distribution: temurin
    - uses: coursier/cache-action@d1039466d0812d6370649b9afb02bbf5f646bacf # v6.4.3
    - run: git config core.whitespace tab-in-indent,trailing-space,space-before-tab,cr-at-eol
    - run: git show --oneline --check
    - shell: bash
      name: install sbt
      run: curl -Ls https://raw.githubusercontent.com/dwijnand/sbt-extras/787e7a6c0523cbd995708aec2815a21917315079/sbt > ./sbt && chmod 0755 ./sbt
    - run: |
        case ${{ matrix.name }} in
          "jvm")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            scalafmtCheckAll \
            scalafmtSbtCheck \
            checkGenerateCodeError \
            "rootJVM/Test/compile" \
            "scalapropsTestNames" \
            "scalapropsJVM/test" \
            "scalazJVM/test" \
            "rootJVM/publishLocal" \
            ;;
          "js")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            "rootJS/Test/compile" \
            "scalapropsJS/test" \
            "scalazJS/test" \
            "rootJS/publishLocal"
            ;;
          "native")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            "scalapropsNative/test" \
            "scalazNative/test" \
            "rootNative/publishLocal"
            ;;
          *)
            echo "unknown job-name"
            exit 1
        esac
    - uses: mikepenz/action-junit-report@7210fead7f92f6395c37241964df3b0f730f5e4e # v3.7.1
      if: ${{ always() && matrix.name == 'jvm' }}
      with:
        report_paths: '**/target/test-reports/*.xml'
        require_tests: true
        check_name: "${{ matrix.java }}-${{ matrix.scala }}-${{ matrix.name }}"
    - uses: test-summary/action@v2
      if: ${{ always() && matrix.name == 'jvm' }}
      with:
        paths: '**/target/test-reports/*.xml'
    - run: rm -rf "$HOME/.ivy2/local"
