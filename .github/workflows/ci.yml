name: CI
on:
  pull_request:
  push:
  schedule:
  - cron: '0 6 * * 3'
jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    strategy:
      fail-fast: false
      matrix:
        name: [jvm, js, native]
        scala: ["2.12.*", "2.13.*", "3.*"]
        java: [8]
        include:
          - name: jvm
            scala: "2.13.*"
            java: 21
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    - uses: actions/setup-java@0ab4596768b603586c0de567f2430c30f5b0d2b0 # v3.13.0
      with:
        java-version: ${{matrix.java}}
        distribution: temurin
    - uses: coursier/cache-action@d1039466d0812d6370649b9afb02bbf5f646bacf # v6.4.3
    - run: git config core.whitespace tab-in-indent,trailing-space,space-before-tab,cr-at-eol
    - run: git show --oneline --check
    - shell: bash
      name: install sbt
      run: curl -Ls https://raw.githubusercontent.com/dwijnand/sbt-extras/787e7a6c0523cbd995708aec2815a21917315079/sbt > ./sbt && chmod 0755 ./sbt
    - run: |
        case ${{ matrix.name }} in
          "jvm")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            scalafmtCheckAll \
            scalafmtSbtCheck \
            checkGenerateCodeError \
            "rootJVM/Test/compile" \
            "scalapropsTestNames" \
            "scalapropsJVM/test" \
            "scalazJVM/test" \
            "rootJVM/publishLocal" \
            ;;
          "js")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            "rootJS/Test/compile" \
            "scalapropsJS/test" \
            "scalazJS/test" \
            "rootJS/publishLocal"
            ;;
          "native")
            ./sbt -v \
            -jvm-opts .github/workflows/.jvmopts \
            "++ ${{ matrix.scala }}" \
            "scalapropsNative/test" \
            "scalazNative/test" \
            "rootNative/publishLocal"
            ;;
          *)
            echo "unknown job-name"
            exit 1
        esac
    - uses: mikepenz/action-junit-report@0a8a5ba57593d67b2e45de2c543b438412382b7b # v4.0.1
      if: ${{ always() && matrix.name == 'jvm' }}
      with:
        report_paths: '**/target/test-reports/*.xml'
        require_tests: true
        check_name: "${{ matrix.java }}-${{ matrix.scala }}-${{ matrix.name }}"
    - uses: test-summary/action@62bc5c68de2a6a0d02039763b8c754569df99e3f
      if: ${{ always() && matrix.name == 'jvm' }}
      with:
        paths: '**/target/test-reports/*.xml'
    - run: rm -rf "$HOME/.ivy2/local"
